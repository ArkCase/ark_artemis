#!/bin/bash

set -euo pipefail
. /.functions

ARTIFACT_IDS=(
	org.eclipse.jetty:jetty-alpn-java-server
	org.eclipse.jetty:jetty-alpn-server
	org.eclipse.jetty:jetty-ee
	org.eclipse.jetty:jetty-http
	org.eclipse.jetty:jetty-io
	org.eclipse.jetty:jetty-security
	org.eclipse.jetty:jetty-server
	org.eclipse.jetty:jetty-session
	org.eclipse.jetty:jetty-util
	org.eclipse.jetty:jetty-xml

	org.eclipse.jetty.ee9:jetty-ee9-nested
	org.eclipse.jetty.ee9:jetty-ee9-security
	org.eclipse.jetty.ee9:jetty-ee9-servlet
	org.eclipse.jetty.ee9:jetty-ee9-webapp

	org.eclipse.jetty.http2:jetty-http2-common
	org.eclipse.jetty.http2:jetty-http2-hpack
	org.eclipse.jetty.http2:jetty-http2-server
)
VERSION="12.0.25"

set_or_default BASE_DIR "/app"
set_or_default HOME_DIR "${BASE_DIR}/artemis"
set_or_default LIB_DIR "${HOME_DIR}/lib"

eyes "Applying remediation for CVE-2025-5115"
for ARTIFACT_ID in "${ARTIFACT_IDS[@]}" ; do
	find "${LIB_DIR}" -type f -name "${ARTIFACT_ID##*:}-12.*" -delete -print
	mvn-get "${ARTIFACT_ID}:${VERSION}:jar" "${LIB_DIR}"
done
fail "Remediation complete"
